name: Deploy BookingBite Backend

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.py"
      - "requirements.txt"
      - ".github/workflows/deploy-backend.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: bookingbite-backend-prod
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, windows, iis, bookingbite]
    env:
      HTTPS_PROXY: http://proxy.hlag.com:11009
      HTTP_PROXY: http://proxy.hlag.com:11009
      NO_PROXY: 127.0.0.1,localhost,*.hlag.com
      REQUESTS_CA_BUNDLE: C:\certs\hlag-zscaler-root.pem
      SSL_CERT_FILE: C:\certs\hlag-zscaler-root.pem
      PIP_CERT: C:\certs\hlag-zscaler-root.pem
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mirror repo to server deploy dir (ROBOCOPY v3)
        shell: powershell
        run: |
          Write-Host "USING NEW MIRROR STEP v3"
          if (!(Test-Path 'C:\deployments\bbserver')) {
            New-Item -ItemType Directory -Path 'C:\deployments\bbserver' | Out-Null
          }
          $src = "$env:GITHUB_WORKSPACE"
          $dst = "C:\deployments\bbserver"
          robocopy $src $dst /MIR /R:5 /W:2 /NFL /NDL /NP `
            /XD .git node_modules .venv venv __pycache__ `
            /XF *.log waitress_stdout.log waitress_stderr.log *.pyc db.sqlite3 *.sqlite3 | Out-Host
          $code = $LASTEXITCODE
          if ($code -lt 8) {
            Write-Host "Robocopy exit code $code => success."
            exit 0
          } else {
            Write-Error "Robocopy failed with code $code"
            exit $code
          }

      - name: Deploy backend (venv, pip install, migrate, restart)
        run: |
          C:\deployments\scripts\deploy-backend.ps1 -RepoDir 'C:\deployments\bbserver' -ServiceName 'bookingbite_api'
